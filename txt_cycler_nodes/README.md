# Prompt Cycler Node for ComfyUI

这个ComfyUI节点可以按行读取文本文件中的提示词，并按照设定的使用次数自动切换。还提供通配符功能。

## 节点类型

1. **Prompt Cycler**: 基本提示词循环器，按照设定次数使用每个提示词后自动切换
2. **Wildcard Prompt Cycler**: 增强版循环器，支持通配符功能，使用 `$wildcard$` 格式引用通配符文件

## 功能特点

### 基本功能 (Prompt Cycler)
1. 按照分段读取输入txt文件，每一行作为单独的提示词
2. 自动切换：用过一行提示词后，按照设定的使用次数切换到下一行提示词输入
3. 直接在提示词中显示剩余使用次数倒计时
4. 可选循环模式：当读完所有提示词后，可以选择是否重新从第一个提示词开始
5. 可以接收任何节点的输出作为触发信号，减少使用次数

### 通配符功能 (Wildcard Prompt Cycler)
1. 支持通配符语法：`$wildcard$` 会被替换为 wildcard.txt 文件中的随机一行
2. 支持子目录查找：自动在通配符目录及其子目录中寻找匹配的通配符文件
3. 通配符解析使用种子确保重现性：相同种子产生相同的通配符选择
4. 通配符文件缓存：提高性能，避免重复读取相同的通配符文件

## 安装方法

1. 将`txt_cycler_nodes`文件夹复制到ComfyUI的`custom_nodes`目录下
2. 重启ComfyUI

## 使用方法

### Prompt Cycler
1. 在ComfyUI中，从节点菜单中选择"prompt"类别，找到"Prompt Cycler"节点
2. 设置以下参数：
   - `text_file`: 提示词文本文件的路径
   - `uses_per_prompt`: 每个提示词使用的次数
   - `enable_loop`: 是否启用循环模式（读完所有提示词后重新开始）
   - `reset_counter`: 是否重置计数器（重新从第一个提示词开始）
3. 可选连接：
   - `trigger_signal`: 连接任何节点的输出作为触发信号，每当收到新信号时减少1次使用次数

### Wildcard Prompt Cycler
1. 在ComfyUI中，从节点菜单中选择"prompt"类别，找到"Wildcard Prompt Cycler"节点
2. 设置以下参数：
   - `text_file`: 提示词文本文件的路径
   - `uses_per_prompt`: 每个提示词使用的次数
   - `enable_loop`: 是否启用循环模式（读完所有提示词后重新开始）
   - `reset_counter`: 是否重置计数器（重新从第一个提示词开始）
   - `wildcards_dir`: 通配符文件所在的目录路径
   - `seed`: 随机种子，用于通配符选择的确定性
3. 可选连接：
   - `trigger_signal`: 连接任何节点的输出作为触发信号，每当收到新信号时减少1次使用次数

## 提示词文件格式

提示词文件中的每一行将被视为一个单独的提示词，例如：

```
第一个提示词
第二个提示词 $style$
第三个提示词 $character$ in $location$
```

空行会被自动忽略。以 `#` 开头的行被视为注释，也会被忽略。

## 通配符文件格式

通配符文件应该放在 `wildcards_dir` 指定的目录下，文件名为 `通配符名称.txt`。例如，引用 `$style$` 时，会在通配符目录中查找 `style.txt` 文件。

通配符文件中的每一行将被视为一个可能的选项，程序会随机选择其中一行作为替换值。例如 `style.txt` 可能包含：

```
油画风格
水彩风格
素描风格
# 这是注释，会被忽略
数字艺术风格
```

当解析 `$style$` 通配符时，会随机选择上述四种风格之一进行替换。

## 剩余使用次数倒计时显示

节点会直接在提示词后面显示剩余使用次数和当前行号，格式为：
```
提示词内容 [Line: 当前行/总行数 | Remaining: 剩余次数/总次数]
```

这样你可以直接看到当前使用的是哪一行提示词，以及还剩多少次使用次数。

## 触发使用次数减少

要实现自动减少使用次数，你可以将任何节点的输出连接到Prompt Cycler的`trigger_signal`输入。例如：

1. 将VAE解码器的图像输出连接到Prompt Cycler的`trigger_signal`输入
2. 每当VAE解码器生成新图像时，Prompt Cycler会检测到输入变化并减少使用次数
3. 当使用次数减少到0时，会自动切换到下一行提示词

## 示例工作流

### 基本用法
将Prompt Cycler节点的`prompt`输出连接到KSampler的提示词输入，这样每次生成图像时都会按照设定自动切换提示词。

### 通配符用法
1. 创建一个包含通配符的提示词文件，例如：`一个 $风格$ 的 $主题$ 场景`
2. 在通配符目录中创建对应的通配符文件：`风格.txt` 和 `主题.txt`
3. 使用Wildcard Prompt Cycler节点处理这个提示词文件
4. 将结果连接到KSampler的提示词输入

### 自动减少使用次数
1. 将VAE解码器的图像输出连接到Prompt Cycler的`trigger_signal`输入
2. 这样每生成一张新图像，使用次数就会自动减少1
3. 当使用次数减少到0时，会自动切换到下一行提示词 